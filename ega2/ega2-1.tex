\cite{I-1}.

\section{Affine morphisms}
\label{section:affine-morphisms}

\subsection{$S$-preschemes and $\mathcal{O}_S$-algebras}
\label{subsection:s-preschemes-algebras}

\begin{env}[1.1.1]
\label{2.1.1.1}
Let $S$ be a prescheme, $X$ an $S$-prescheme, and $f:X\to S$ its structure morphism.
We know \sref[0]{0.4.2.4} that the direct image $f_*(\OO_X)$ is an $\OO_S$-algebra, which we
\oldpage[II]{6}
denote $\sh{A}(X)$ when there is little chance of confusion; if $U$ is an open subset of $S$, then we have
\[
  \sh{A}(f^{-1}(U))=\sh{A}(X)|U.
\]
Similarly, for every $\OO_X$-module $\sh{F}$ (resp. every $\OO_X$-algebra $\sh{B}$), we write $\sh{A}(\sh{F})$ (resp. $\sh{A}(\sh{B})$) for the direct image $f_*(\sh{F})$ (resp. $f_*(\sh{B})$) which is an $\sh{A}(X)$-module (resp. an $\sh{A}(X)$-algebra) and not only an $\OO_S$-module (resp. an $\OO_S$-algebra).
\end{env}

\begin{env}[1.1.2]
\label{2.1.1.2}
Let $Y$ be a second $S$-prescheme, $g:Y\to S$ its structure morphism, and $h:X\to Y$ an $S$-morphism; we then have the commutative diagram
\[
  \xymatrix{
    X\ar[rr]^h\ar[rd]_f & &
    Y\ar[ld]^g\\
    & S.
  }
  \tag{1.1.2.1}
\]

We have by definition $h=(\psi,\theta)$, where $\theta:\OO_Y\to h_*(\OO_X)=\psi_*(\OO_X)$ is a homomorphism of sheaves of rings; we induce \sref[0]{0.4.2.2} a homomorphism of $\OO_S$-algebras $g_*(\theta):g_*(\OO_Y)\to g_*(h_*(\OO_X))=f_*(\OO_X)$, in other words, a homomorphism of $\OO_S$-algebras $\sh{A}(Y)\to\sh{A}(X)$, which we denote by $\sh{A}(h)$.
If $h':Y\to Z$ is a second $S$-morphism, then it is immediate that $\sh{A}(h'\circ h)=\sh{A}(h)\circ\sh{A}(h')$.
We havve thus define a \emph{contravariant functor $\sh{A}(X)$} from the category of $S$-preschemes to the category of $\OO_S$-algebras.

Now let $\sh{F}$ be an $\OO_X$-module, $\sh{G}$ an $\OO_Y$-module, and $u:\sh{G}\to\sh{F}$ an $h$-morphism, that is \sref[0]{0.4.4.1} a homomorphism of $\OO_Y$-modules $\sh{G}\to h_*(\sh{F})$.
Then $g_*(u):g_*(\sh{G})\to g_*(h_*(\sh{F}))=f_*(\sh{F})$ is a homomorphism $\sh{A}(\sh{G})\to\sh{A}(\sh{F})$ of $\OO_S$-modules, which we denote by $\sh{A}(u)$; in addition, the pair $(\sh{A}(h),\sh{A}(u))$ form a \emph{di-homomorphism} from the $\sh{A}(Y)$-module $\sh{A}(\sh{G})$ to the $\sh{A}(X)$-module $\sh{A}(\sh{F})$.
\end{env}

\begin{env}[1.1.3]
\label{2.1.1.3}
If we fix the prescheme $S$, then we can consider the pairs $(X,\sh{F})$, where $X$ is an $S$-prescheme and $\sh{F}$ is an $\OO_X$-module, as forming a \emph{category}, by defining a \emph{morphism} $(X,\sh{F})\to(Y,\sh{G})$ as a pair $(h,u)$, where $h:X\to Y$ is an $S$-morphism and $u:\sh{G}\to\sh{F}$ is an $h$-morphism.
We can theen say that $(\sh{A}(X),\sh{A}(\sh{F}))$ is a \emph{contravariant functor} with values in the category whose objects are pairs consisting of an $\OO_S$-algebra and a module over that algebra, and the morphisms are the di-homomorphisms.
\end{env}

\subsection{Affine preschemes over a prescheme}
\label{subsection:affine-preschemes-over-a-prescheme}

\begin{defn}[1.2.1]
\label{2.1.2.1}
Let $X$ be an $S$-prescheme, $f:X\to S$ its structure morphism.
We say that $X$ is \emph{affine over $S$} if there exists a cover $(S_\alpha)$ of $S$ by affine open sets such that for all $\alpha$, the induced prescheme on $X$ by the open set $f^{-1}(S_\alpha)$ is affine.
\end{defn}

\begin{exm}[1.2.2]
\label{2.1.2.2}
Every closed subprescheme of $S$ is an affine $S$-prescheme over $S$ (\sref[I]{1.4.2.3} and \sref[I]{1.4.2.4}).
\end{exm}

\begin{rmk}[1.2.3]
\label{2.1.2.3}
An affine prescheme $X$ over $S$ is not necessarily an affine scheme, as the example $X=S$ shows \sref{2.1.2.2}.
On the other hand, if an affine scheme $X$ is an $S$-prescheme, then $X$ is not necessarily affine over
\oldpage[II]{7}
$S$ (see Example~\sref{2.1.3.3}).
However, remember that if $S$ is a \emph{scheme}, then every $S$-prescheme which is an affine scheme is affine over $S$ \sref[I]{1.5.5.10}.
\end{rmk}

\begin{prop}[1.2.4]
\label{2.1.2.4}
Every $S$-prescheme which is affine over $S$ is separated over $S$ (in other words, it is an $S$-scheme).
\end{prop}

\begin{proof}
\label{proof-2.1.2.4}
This follows immediately from \sref[I]{1.5.5.5} and \sref[I]{1.5.5.8}.
\end{proof}

\begin{prop}[1.2.5]
\label{2.1.2.5}
Let $X$ be an $S$-scheme affine over $S$, $f:X\to S$ its structure morphism.
For every open $U\subset S$, $f^{-1}(U)$ is affine over $U$.
\end{prop}

\begin{proof}
\label{proof-2.1.2.5}
By Definition~\sref{2.1.2.1}, we can reduce to the case where $S=\Spec(A)$ and $X=\Spec(B)$ are affine; then $f=({}^a\vphi,\wt{\vphi})$, where $\vphi:A\to B$ is a homomorphism.
As the $D(g)$ for $g\in A$ form a basis for $S$, we reduce to the case where $U=D(g)$; but we then know that $f^{-1}(U)=D(\vphi(g))$ (\textbf{I},~1.2.2.2), hence the proposition.
\end{proof}

\begin{prop}[1.2.6]
\label{2.1.2.6}
Let $X$ be an $S$-scheme affine over $S$, $f:X\to S$ its structure morphism.
For every quasi-coherent $\OO_X$-module $\sh{F}$, $f_*(\sh{F})$ is a quasi-coherent $\OO_S$-module.
\end{prop}

\begin{proof}
\label{proof-2.1.2.6}
Taking into account Proposition~\sref{2.1.2.4}, this follows from \sref[I]{1.9.2.2}[a].
\end{proof}

In particular, the $\OO_S$-algebra $\sh{A}(X)=f_*(\OO_X)$ is \emph{quasi-coherent}.

\begin{prop}[1.2.7]
\label{2.1.2.7}
Let $X$ be an $S$-scheme affine over $S$.
For every $S$-prescheme $Y$, the map $h\mapsto\sh{A}(h)$ from the set $\Hom_S(Y,X)$ to the set $\Hom(\sh{A}(X),\sh{A}(Y))$ \sref{2.1.1.2} is bijective.
\end{prop}

\begin{proof}
\label{proof-2.1.2.7}
Let $f:X\to S$ and $g:Y\to S$ be the structure morphisms.
First, suppose that $S=\Spec(A)$ and $X=\Spec(B)$ are affine; we must prove that for every homomorphism $\omega:f_*(\OO_X)\to g_*(\OO_Y)$ of $\OO_S$-algebras, there exists a unique $S$-morphism $h:Y\to X$ such that $\sh{A}(h)=\omega$.
By definition, for every open $U\subset S$, $\omega$ defines a homomorphism $\omega_U=\Gamma(U,\omega):\Gamma(f^{-1}(U),\OO_X)\to\Gamma(g^{-1}(U),\OO_Y)$ of $\Gamma(U,\OO_S)$-algebras.
In particular, for $U=S$, this gives a homomorphism $\vphi:\Gamma(X,\OO_X)\to\Gamma(Y,\OO_Y)$ of $\Gamma(S,\OO_S)$-algebras, to which corresponds a well-defined $S$-morphism $h:Y\to X$, since $X$ is affine \sref[I]{1.2.2.4}.
It remains to prove that $\sh{A}(h)=\omega$, in other words, for every open set $U$ of a basis for $S$, $\omega_U$ coincides with the homomorphism of algebras $\vphi_U$ corresponding to the $S$-morphism $g^{-1}(U)\to f^{-1}(U)$, a restiction of $h$.
We can reduce to the case where $U=D(\lambda)$, with $\lambda\in S$; then, if $f=({}^a\rho,\wt{\rho})$, where $\rho:A\to B$ is a ring homomorphism, we have $f^{-1}(U)=D(\mu)$, where $\mu=\rho(\lambda)$, and $\Gamma(f^{-1}(U),\OO_X)$ is the ring of fractions $B_\mu$; the diagram
\[
  \xymatrix{
    B\ar[r]^\vphi\ar[d] &
    \Gamma(Y,\OO_Y)\ar[d]\\
    B_\mu\ar[r]^{\vphi_U} &
    \Gamma(g^{-1}(U),\OO_Y)
  }
\]
is commutative, and so is the analogous diagram where $\vphi_U$ is replaced by $\omega_U$; the equality $\vphi_U=\omega_U$ then follows from the universal property of rings of fractions \sref[0]{0.1.2.4}.

We now pass to the general case; let $(S_\alpha)$ be a cover of $S$ by affine open sets
\oldpage[II]{8}
such that the $f^{-1}(S_\alpha)$ are affine.
Then every homomorphism $\omega:\sh{A}(X)\to\sh{A}(Y)$ of $\OO_S$-algebras gives by restriction a family of homomorphisms
\[
  \omega_\alpha:\sh{A}(f^{-1}(S_\alpha))\to\sh{A}(g^{-1}(S_\alpha))
\]
of $\OO_{S_\alpha}$-algebras, hence a family of $S_\alpha$-morphisms $h_\alpha:g^{-1}(S_\alpha)\to f^{-1}(S_\alpha)$ by the above.
It remains to see that for every affine open set of a basis for $S_\alpha\cap S_\beta$, the restriction of $h_\alpha$ and $h_\beta$ to $g^{-1}(U)$ coincide, which is evident since by the above, these restrictions both correspond to the homomorphism $\sh{A}(X)|U\to\sh{A}(Y)|U$, a restriction of $\omega$.
\end{proof}

\begin{cor}[1.2.8]
\label{2.1.2.8}
Let $X$ and $Y$ be two $S$-schemes which are affine over $S$.
For an $S$-morphism $h:Y\to X$ to be an isomorphism, it is necessary and sufficient for $\sh{A}(h):\sh{A}(X)\to\sh{A}(Y)$ to be an isomorphism.
\end{cor}

\begin{proof}
\label{proof-2.1.2.8}
This follows immediately from Proposition~\sref{2.1.2.7} and from the functorial nature of $\sh{A}(X)$.
\end{proof}

\subsection{Affine preschemes over $S$ associated to an $\mathcal{O}_S$-algebra}
\label{subsection:affine-preschemes-associated-to-algebra}

\begin{prop}[1.3.1]
\label{2.1.3.1}
Let $S$ be a prescheme.
For every quasi-coherent $\OO_S$-algebra $\sh{B}$, there exists a prescheme $X$ affine over $S$, defined up to unique $S$-isomorphism, such that $\sh{A}(X)=\sh{B}$.
\end{prop}

\begin{proof}
\label{proof-2.1.3.1}
The uniqueness follows from Corollary~\sref{2.1.2.8}; we prove the existence of $X$.
For every affine open $U\subset S$, let $X_U$ be the prescheme $\Spec(\Gamma(U,\sh{B}))$; as $\Gamma(U,\sh{B})$ is a $\Gamma(U,\OO_S)$-algebras, $X_U$ is an $S$-prescheme \sref[I]{1.1.6.1}.
In addition, as $\sh{B}$ is quasi-coherent, the $\OO_S$-algebra $\sh{A}(X_U)$ canonically identifies with $\sh{B}|U$ (\sref[I]{1.1.3.7}, \sref[I]{1.1.3.13}, \sref[I]{1.1.6.3}).
Let $V$ be a second affine open subset of $S$, and let $X_{U,V}$ be the prescheme induced by $X_U$ on $f_U^{-1}(U\cap V)$, where $f_U$ denotes the structure morphism $X_U\to S$; $X_{U,V}$ and $X_{V,U}$ are affine over $U\cap V$ \sref{2.1.2.5}, and by definition $\sh{A}(X_{U,V})$ and $\sh{A}(X_{V,U})$ canonically identify with $\sh{B}|(U\cap V)$.
Hence there is \sref{2.1.2.8} a canonical $S$-isomorphism $\theta_{U,V}:X_{U,V}\to X_{U,V}$; in addition, if $W$ is a third affine open subset of $S$, and if $\theta_{U,V}'$, $\theta_{V,W}'$, and $\theta_{U,W}'$ are the restrictions of $\theta_{U,V}$, $\theta_{V,W}$, and $\theta_{U,W}$ to the inverse images of $U\cap V\cap W$ in $X_V$, $X_W$, and $X_W$ respectively under the structure morphisms, then we have $\theta_{U,V}'\circ\theta_{V,W}'=\theta_{U,W}'$.
As a result, there exists a prescheme $X$, a cover $(T_U)$ of $X$ by affine open sets, and for every $U$ an isomorphism $\vphi_U:X_U\to T_U$, such that $\vphi_U$ maps $f_U^{-1}(U\cap V)$ to $T_U\cap T_V$, and we have $\theta_{U,V}=\vphi_U^{-1}\circ\vphi_V$ \sref[I]{1.2.3.1}.
The morphism $g_U=f_U\circ\vphi_U^{-1}$ makes $T_U$ an $S$-prescheme, and the morphisms $g_U$ and $g_V$ coincide on $T_U\cap T_V$, hence $X$ is an $S$-prescheme.
In addition, it is clear by definition that $X$ is affine over $S$ and that $\sh{A}(T_U)=\sh{B}|U$, hence $\sh{A}(X)=\sh{B}$.
\end{proof}

We say that the $S$-scheme $X$ defined in this way is \emph{associated to the $\OO_S$-algebra $\sh{B}$}, or is the \emph{spectrum of $\sh{B}$}, and we denote it by $\Spec(\sh{B})$.

\begin{cor}[1.3.2]
\label{2.1.3.2}
Let $X$ be a prescheme affine over $S$, $f:X\to S$ the structure morphism.
For every affine open $U\subset S$, the induced prescheme on $f^{-1}(U)$ is the affine scheme with ring $\Gamma(U,\sh{A}(X))$.
\end{cor}

\begin{proof}
\label{proof-2.1.3.2}
\oldpage[II]{9}
As we can suppose that $X$ is associated to an $\OO_S$-algebra by Propositions~\sref{2.1.2.6} and \sref{2.1.3.1}, the corollary follows from the construction of $X$ described in Proposition~\sref{2.1.3.1}.
\end{proof}

\begin{exm}[1.3.3]
\label{2.1.3.3}
Let $S$ be the affine plane over a field $K$, where the point $0$ has been doubled \sref[I]{1.5.5.11}; with the notation of \sref[I]{1.5.5.11}, $S$ is the union of two affine open sets $Y_1$ and $Y_2$; if $f$ is the open immersion $Y_1\to S$, then $f^{-1}(Y_2)=Y_1\cap Y_2$ is not an affine open set in $Y_1$ (\emph{loc. cit.}), hence we have an example of an affine scheme which is not affine over $S$.
\end{exm}

\begin{cor}[1.3.4]
\label{2.1.3.4}
Let $S$ be an affine scheme; for an $S$-prescheme $X$ to be affine over $S$, it is necessary and sufficient for $X$ to be an affine scheme.
\end{cor}

\begin{cor}[1.3.5]
\label{2.1.3.5}
Let $X$ be a prescheme affine over a prescheme $S$, and let $Y$ be an $X$-prescheme.
For $Y$ to be affine over $S$, it is necessary and sufficient for $Y$ to be affine over $X$.
\end{cor}

\begin{proof}
\label{proof-2.1.3.5}
We immediately reduce to the case where $S$ is an affine scheme, and then we can reduce to the case where $X$ is an affine scheme \sref{2.1.3.4}; the two conditions of the statement then give that $Y$ is an affine scheme \sref{2.1.3.4}.
\end{proof}

\begin{env}[1.3.6]
\label{2.1.3.6}
Let $X$ be a prescheme affine over $S$.
To define a prescheme $Y$ affine \emph{over $X$}, it is equivalent, by Corollary~\sref{2.1.3.5}, to give a prescheme $Y$ affine \emph{over $S$}, and an $S$-morphism $g:Y\to X$; in other words (Proposition~\sref{2.1.3.1} and \sref{2.1.2.7}), it is equivalent to give a quasi-coherent $\OO_S$-algebra $\sh{B}$ and a homomorphism $\sh{A}(X)\to\sh{B}$ of $\OO_S$-algebras (which can be considered as defining on $\sh{B}$ an $\sh{A}(X)$-algebra structure).
If $f:X\to S$ is the structure morphism, then we have $\sh{B}=f_*(g_*(\OO_Y))$.
\end{env}

\begin{cor}[1.3.7]
\label{2.1.3.7}
Let $X$ be a prescheme affine over $S$; for $X$ to be of finite type over $S$, it is necessary and sufficient for the quasi-coherent $\OO_S$-algebra $\sh{A}(X)$ to be of finite type \sref[I]{1.9.6.2}.
\end{cor}

\begin{proof}
\label{proof-2.1.3.7}
By definition \sref[I]{1.9.6.2}, we can reduce to the case where $S$ is affine; then $X$ is an affine scheme \sref{2.1.3.4}, and if $S=\Spec(A)$, $X=\Spec(B)$, then $\sh{A}(X)$ is the $\OO_S$-algebra $\wt{B}$; as $\Gamma(U,\wt{B})=B$, the corollary follows from \sref[I]{1.9.6.2} and \sref[I]{1.6.3.3}.
\end{proof}

\begin{cor}[1.3.8]
\label{2.1.3.8}
Let $X$ be a prescheme affine over $S$; for $X$ to be reduced, it is necessary and sufficient for the quasi-coherent $\OO_X$-algebra $\sh{A}(X)$ to be reduced \sref[0]{0.4.1.4}.
\end{cor}

\begin{proof}
\label{proof-2.1.3.8}
The question is local on $S$; by Corollary~\sref{2.1.3.2}, the corollary follows from \sref[I]{1.5.1.1} and \sref[I]{1.5.1.4}.
\end{proof}

\subsection{Quasi-coherent sheaves over a prescheme affine over $S$}
\label{subsection:quasi-coherent-sheaves-on-prescheme-affine-over}

